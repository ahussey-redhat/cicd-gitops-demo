---
- name: Deploy CA bundle
  kubernetes.core.k8s:
    resource_definition:
      kind: ConfigMap
      apiVersion: v1
      metadata:
        name: custom-ca
        namespace: openshift-config
      data:
        ca-bundle.crt: |-
          -----BEGIN CERTIFICATE-----
          MIIE+TCCA+GgAwIBAgITFQAAAQ2T9TUxKt1o3AAAAAABDTANBgkqhkiG9w0BAQsF
          ADAfMR0wGwYDVQQDExRIVVNTRE9HRy1IVVNTREMwMS1DQTAeFw0yMDA3MTQwNDA3
          NDJaFw0yNTA3MTMwNDA3NDJaMDsxGTAXBgNVBAoTEElETS5IVVNTRE9HRy5DT00x
          HjAcBgNVBAMTFUNlcnRpZmljYXRlIEF1dGhvcml0eTCCAaIwDQYJKoZIhvcNAQEB
          BQADggGPADCCAYoCggGBANJt5lAlFfiV9XupBTd4nPGA0ApYlABgc6F8LF5mFGoj
          JNZU9fOd6kj53fnmI0WdTkIXMvrmmn302t/8aeqY7Dy6hElnUkHDRnZAdkBXUTQk
          C5Nr3SM0N2TafWMr65Y7v3BTbf74tkuWtbosVMLUSW/IkizFmOsBhCvFrssU7juv
          3GqL/d3u9U+7FX04ekpO06SeHNHzb/3TpzJ0rMGXwFNpYvvmzTuGrrGF1QOXcQPZ
          jycAz3KtCSlmtxaecxWVD/fNUEncbUQuG1d7RqWy8SWcNJ0h58Ycnh3XLUvoFJkk
          h9rKhP8wR6Mb5PRrWSsolmArrWaqjnp9E0QGdIqCIEA8Ev0/2We1sGqaT1JMS/Em
          IYL+4bZED4J8vswd+zF1pHSj9XyPsl9wG/SDHki3yjZ8PYiBQjJTLsLWP/coXfhw
          aYx5WPto/rD9EHLbl5Ysi9luNcTOZ9bYVPLQ7t2LjfZxIGwgiZkr45KftZwGeqy9
          WTkLmU8tUl0TG2wqJyeYLwIDAQABo4IBkDCCAYwwGQYJKwYBBAGCNxQCBAweCgBT
          AHUAYgBDAEEwDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAYYwHQYDVR0O
          BBYEFNkRLlQKv0uwIs+ix7g2zxiFCh6kMB8GA1UdIwQYMBaAFNulpCq7JDacyJaQ
          R8SNVtrusJtMMEQGA1UdHwQ9MDswOaA3oDWGM2h0dHA6Ly9IVVNTREMwMS9DZXJ0
          RW5yb2xsL0hVU1NET0dHLUhVU1NEQzAxLUNBLmNybDCBxwYIKwYBBQUHAQEEgbow
          gbcwgbQGCCsGAQUFBzAChoGnbGRhcDovLy9DTj1IVVNTRE9HRy1IVVNTREMwMS1D
          QSxDTj1BSUEsQ049UHVibGljJTIwS2V5JTIwU2VydmljZXMsQ049U2VydmljZXMs
          Q049Q29uZmlndXJhdGlvbixEQz1IVVNTRE9HRyxEQz1jb20/Y0FDZXJ0aWZpY2F0
          ZT9iYXNlP29iamVjdENsYXNzPWNlcnRpZmljYXRpb25BdXRob3JpdHkwDQYJKoZI
          hvcNAQELBQADggEBAIbTzi5zkUPP2VeFVfGOKcmgSj1n9GSu6gRhOsMNuEHU3MJK
          gi+uJGgLj67blNO1NP37kCS2946S6tRryrCjjMjwhoa+Ehw+Vv7nkPFkPu9bs+II
          V8ncC/xE+dEEs2q36In28IkCbgERZIndQoZTwG/+iUkSCZXzo8Cp3xbZ/hpaIJl+
          kxuz75p51Cqq5URHlixvpMarGF/70CIud5Dfj8y8aa1tBarxpG+gFiC95zVz5bxh
          2zuw2ttY3ceJs3dpvP85Piz3FEsBYwA3i93SdIH2cPYTydNKaZ532DILzXPsPRLj
          1I4AUq79maWgM6ikNOG+sdr1w6Pkg5S826Wm2rs=
          -----END CERTIFICATE-----
          -----BEGIN CERTIFICATE-----
          MIIDDDCCAfSgAwIBAgIQMysKTUAOAZhKIkxEZIz+lzANBgkqhkiG9w0BAQsFADAf
          MR0wGwYDVQQDExRIVVNTRE9HRy1IVVNTREMwMS1DQTAgFw0xOTAzMjgxMDI4MDNa
          GA8yMDU5MDMyMDEwMjgwM1owHzEdMBsGA1UEAxMUSFVTU0RPR0ctSFVTU0RDMDEt
          Q0EwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC5OACtx4vLT2wKjqPn
          PDt6OwXEI3t59mgEgaTCKo5vYZSpG5OYoXjLAFpoip9hAJDGG6SC0LPbbcDLZPDk
          YF0EqEz5ep0u7Yqc+O1U0V50rLCL6NhBGurMY+UYDQGFyr2sXRDqLn2JsqiZCXR3
          fA+RRuwE6ikmkQBplfEHbxOL8ZfQr8sjY7l1fVSxtmsIti3lTG0hOcEDvS4OpOA+
          NEGuYtH13rqw/60n7gOJJj04Opp7N1Edxcz//OjkcqXPpRGkvY4xnNyhKzDYLAn+
          yr8hh+zcIC9nNlaLCkoOA8284eGTwX7ehFH+An5Ou8HD6yUi8glrplaE1dKHWYwv
          CD+XAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBhjAPBgNVHRMBAf8EBTADAQH/MB0G
          A1UdDgQWBBTbpaQquyQ2nMiWkEfEjVba7rCbTDANBgkqhkiG9w0BAQsFAAOCAQEA
          gwys4H2omVVI7wamyUSL8IBireCTr9UemLlc/3ZRtDDzcnX2+K4TRHPjMD2YPf/z
          X4MneNx9Gn3iQZLa5cvPtV4Crzr+bfRAemlFjLDKvbBBDA3yAovGvATFqg9z7Mak
          HtLB//KM+cODwgN4Z7YJwt+MfZ5lAgvcV0OFEY1cpIEJxJKQe2mZAtkYzD+PzgZh
          scoBLl/MSpZ+tHzPDDpMw1pFOfSRwT+O7aCX0dS9/jpUc9AHvYIcpeoPBW+2IToW
          mjV1x8Z3wFTpRXyEBXjKmmz6VLzGZ/6xouyEe9FPTqD+ySrzB7lHmWkC5KCnOGRp
          F5FPFn82AaCHfWmIEXrM8w==
          -----END CERTIFICATE-----

- name: Patch Proxy
  kubernetes.core.k8s:
    resource_definition:
      apiVersion: config.openshift.io/v1
      kind: Proxy
      metadata:
        name: cluster
      spec:
        trustedCA:
          name: custom-ca

- name: Create SSL cert secret
  kubernetes.core.k8s:
    resource_definition:
      kind: Secret
      apiVersion: v1
      metadata:
        name: ingress-certs
        namespace: openshift-ingress
      data:
        tls.crt: "{{ ssl_cert | b64encode }}"
        tls.key: "{{ ssl_private_key | b64encode }}"
      type: kubernetes.io/tls

- name: Patch Ingress Controller
  kubernetes.core.k8s:
    resource_definition:
      apiVersion: operator.openshift.io/v1
      kind: IngressController
      metadata:
        finalizers:
          - ingresscontroller.operator.openshift.io/finalizer-ingresscontroller
        name: default
        namespace: openshift-ingress-operator
      spec:
        clientTLS:
          clientCA:
            name: ''
          clientCertificatePolicy: ''
        defaultCertificate:
          name: ingress-certs
        httpCompression: {}
        httpEmptyRequestsPolicy: Respond
        httpErrorCodePages:
          name: ''
        replicas: 1
        tuningOptions: {}
        unsupportedConfigOverrides: null

